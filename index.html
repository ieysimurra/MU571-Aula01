import React, { useState } from 'react';
import { BookOpen, Layers, Music, Cpu, Activity, ArrowRight, ChevronDown, ChevronUp, Terminal, Play, Disc, X, Youtube, Info, Volume2 } from 'lucide-react';

const CourseIntroApp = () => {
  const [activeTab, setActiveTab] = useState('repertoire'); // Default to repertoire for immediate access check
  const [expandedModule, setExpandedModule] = useState(null);

  const toggleModule = (index) => {
    setExpandedModule(expandedModule === index ? null : index);
  };

  const renderContent = () => {
    switch (activeTab) {
      case 'overview': return <OverviewSection />;
      case 'modules': return <ModulesSection expandedModule={expandedModule} toggleModule={toggleModule} />;
      case 'concepts': return <ConceptsSection />;
      case 'repertoire': return <RepertoireSection />;
      case 'tools': return <ToolsSection />;
      default: return <OverviewSection />;
    }
  };

  return (
    <div className="min-h-screen bg-gray-900 text-gray-100 font-sans selection:bg-cyan-900 pb-12">
      <header className="bg-gray-800 border-b border-gray-700 p-6 sticky top-0 z-20 shadow-lg">
        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center">
          <div>
            <h1 className="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">
              Composição Musical IV
            </h1>
            <p className="text-gray-400 text-sm mt-1">Modelos Tecnomórficos e a Escrita Instrumental Pós-Digital</p>
          </div>
          <div className="mt-4 md:mt-0 flex items-center gap-3">
             <div className="px-3 py-1 bg-cyan-900/30 rounded border border-cyan-700 text-xs font-mono text-cyan-400">
              Aula 00
            </div>
            <div className="px-3 py-1 bg-purple-900/30 rounded border border-purple-700 text-xs font-mono text-purple-400">
              Pós-Graduação
            </div>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto p-4 md:p-6 flex flex-col lg:flex-row gap-6">
        {/* Navigation Sidebar */}
        <nav className="w-full lg:w-64 flex-shrink-0 z-10">
          <div className="bg-gray-800 rounded-lg p-2 md:p-4 lg:sticky lg:top-32 border border-gray-700 shadow-xl overflow-x-auto md:overflow-visible">
            <ul className="flex lg:flex-col space-x-2 lg:space-x-0 lg:space-y-2 min-w-max lg:min-w-0">
              <NavItem id="overview" label="Visão Geral" icon={<Activity size={18} />} activeTab={activeTab} setActiveTab={setActiveTab} />
              <NavItem id="modules" label="Arco do Curso" icon={<Layers size={18} />} activeTab={activeTab} setActiveTab={setActiveTab} />
              <NavItem id="concepts" label="Conceitos" icon={<Cpu size={18} />} activeTab={activeTab} setActiveTab={setActiveTab} />
              <NavItem id="repertoire" label="Repertório & Player" icon={<Music size={18} />} activeTab={activeTab} setActiveTab={setActiveTab} highlight={true} />
              <NavItem id="tools" label="Ferramentas" icon={<Terminal size={18} />} activeTab={activeTab} setActiveTab={setActiveTab} />
            </ul>
          </div>
        </nav>

        {/* Main Content Area */}
        <div className="flex-grow min-w-0">
          <div className="bg-gray-800 rounded-lg border border-gray-700 p-4 md:p-8 shadow-xl min-h-[600px] relative">
            {renderContent()}
          </div>
        </div>
      </main>
    </div>
  );
};

// --- REPERTOIRE SECTION WITH EMBEDDED PLAYER ---

const RepertoireSection = () => {
  const [filter, setFilter] = useState('all');
  const [activeVideo, setActiveVideo] = useState(null);

  // Helper to extract YouTube ID
  const getYoutubeId = (url) => {
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
  };

  const handlePlay = (work, link) => {
    const videoId = getYoutubeId(link.url);
    if (videoId) {
      setActiveVideo({
        ...work,
        videoId: videoId,
        url: link.url
      });
      // Scroll to top of player on mobile
      window.scrollTo({ top: 100, behavior: 'smooth' });
    } else {
      window.open(link.url, '_blank');
    }
  };

  const repertoireData = [
    {
      module: "Módulo 1: Espectralismo & Transdução",
      color: "border-blue-500",
      works: [
        {
          composer: "Gérard Grisey",
          title: "Partiels",
          year: "1975",
          desc: "O nascimento do espectralismo. A orquestra 'transduz' o espectro de um Mi grave de trombone.",
          links: [
            { label: "Ouvir Obra (Ensemble Court-circuit)", url: "https://www.youtube.com/watch?v=1QLICwmOtjc" },
            { label: "Análise Visual", url: "https://www.youtube.com/watch?v=2LAtJHFJuog" }
          ]
        },
        {
          composer: "Gérard Grisey",
          title: "Vortex Temporum",
          year: "1996",
          desc: "Uso de arpejos para imitar ondas senoidais, quadradas e dente-de-serra.",
          links: [
            { label: "Performance BCMG", url: "https://www.youtube.com/watch?v=70xJ0Sdc2G8" },
            { label: "Versão Ictus (Studio)", url: "https://www.youtube.com/watch?v=f_CkCypPFAQ" }
          ]
        },
        {
          composer: "Tristan Murail",
          title: "Gondwana",
          year: "1980",
          desc: "Interpolação harmônica simulando síntese FM entre sino e trombone.",
          links: [
            { label: "Ouvir com Partitura", url: "https://www.youtube.com/watch?v=uaPVaPPDmVs" }
          ]
        }
      ]
    },
    {
      module: "Módulo 2: Granularidade & Textura",
      color: "border-green-500",
      works: [
        {
          composer: "Iannis Xenakis",
          title: "Metastaseis",
          year: "1954",
          desc: "Glissandi massivos criando superfícies sonoras. Precursor da granularidade.",
          links: [
            { label: "Visualização Espectral", url: "https://www.youtube.com/watch?v=u81IGEFt7dM" },
            { label: "Com Partitura", url: "https://www.youtube.com/watch?v=SZazYFchLRI" }
          ]
        },
        {
          composer: "Silvio Ferraz",
          title: "Lamento Quase Mudo",
          year: "Contemporâneo",
          desc: "Violoncelo tratado como gerador de ruído e granulação.",
          links: [
            { label: "Performance (Safi Zerbinatti)", url: "https://www.youtube.com/watch?v=4gxmlRtXOiY" }
          ]
        },
        {
          composer: "Barry Truax",
          title: "Riverrun",
          year: "1986",
          desc: "Obra seminal de síntese granular pura.",
          links: [
            { label: "Ouvir Obra", url: "https://www.youtube.com/watch?v=lP1mqsNEz-s" }
          ]
        }
      ]
    },
    {
      module: "Módulo 3: Tempo, Loop & Glitch",
      color: "border-purple-500",
      works: [
        {
          composer: "Bernhard Lang",
          title: "Monadologie V",
          year: "2009",
          desc: "A estética do CD riscado aplicada ao piano acústico.",
          links: [
            { label: "Ouvir (Marino Formenti)", url: "https://www.youtube.com/watch?v=AJeuwpY3khw" }
          ]
        },
        {
          composer: "Stefan Prins",
          title: "Piano Hero #1",
          year: "2011",
          desc: "O músico como avatar. Dissociação entre gesto físico e resultado sonoro.",
          links: [
            { label: "Performance (Zubin Kanga)", url: "https://www.youtube.com/watch?v=vB7mHSxlE3g" }
          ]
        },
        {
          composer: "Flo Menezes",
          title: "Parcours de l'Entité",
          year: "1994",
          desc: "Maximalismo: densidade instrumental competindo com processamento digital.",
          links: [
            { label: "Excertos / Obra", url: "https://www.youtube.com/watch?v=3fizz1wIPko" } 
          ]
        }
      ]
    },
    {
      module: "Módulo 4: Percussão & Corpo",
      color: "border-red-500",
      works: [
        {
          composer: "Helmut Lachenmann",
          title: "Pression",
          year: "1969",
          desc: "Musique concrète instrumentale. O corpo do instrumento como território.",
          links: [
            { label: "Performance (Lucas Fels)", url: "https://www.youtube.com/watch?v=aeF6W9M8aBo" }
          ]
        },
        {
          composer: "Cesar Traldi",
          title: "Cambucá",
          year: "2000s",
          desc: "Percussão múltipla brasileira e tape. Interpretação mediada.",
          links: [
            { label: "Performance ao Vivo", url: "https://www.youtube.com/watch?v=aeF6W9M8aBo" }
          ]
        }
      ]
    },
    {
      module: "Popular, Eletrônica & Híbridos",
      color: "border-yellow-500",
      works: [
        {
          composer: "Aphex Twin",
          title: "Glitch & Granular",
          year: "Vários",
          desc: "Uso pioneiro de síntese granular para criar percussão fragmentada.",
          links: [
            { label: "Tutorial: Estilo Aphex Twin", url: "https://www.youtube.com/watch?v=wSRi1q30og8" }
          ]
        },
        {
          composer: "Anitta / Prod. Gabriel do Borel",
          title: "Funk Generation",
          year: "2024",
          desc: "Hibridização Funk Carioca + EDM. Tecnomorfismo cultural globalizado.",
          links: [
            { label: "Funk Rave (Video Oficial)", url: "https://www.youtube.com/watch?v=SXFn-m7c5vY" }
          ]
        },
        {
          composer: "SOPHIE",
          title: "Sound Design",
          year: "2015-2021",
          desc: "Hyperpop: Distorção extrema usada como ferramenta de síntese tímbrica.",
          links: [
            { label: "Tutorial de Sound Design", url: "https://www.youtube.com/watch?v=jGc61a9fPGo" }
          ]
        },
        {
          composer: "Arca",
          title: "Mutant",
          year: "2015",
          desc: "A falha e a granulação como estética de corpo queer/híbrido.",
          links: [
            { label: "Análise de Produção", url: "https://www.youtube.com/watch?v=fEzzZUUEvSk" }
          ]
        }
      ]
    }
  ];

  return (
    <div className="flex flex-col lg:flex-row gap-6 animate-fadeIn h-full">
      {/* List Column */}
      <div className={`flex-1 space-y-6 transition-all duration-300 ${activeVideo ? 'lg:w-1/2' : 'w-full'}`}>
        <div>
          <h2 className="text-2xl font-bold text-cyan-400 mb-2">Repertório de Estudo</h2>
          <p className="text-gray-400 text-sm mb-4">
            Selecione uma obra para carregar o player.
          </p>
          
          <div className="flex gap-2 overflow-x-auto pb-2 mb-4 scrollbar-hide">
            {['all', 'Módulo 1', 'Módulo 2', 'Módulo 3', 'Popular'].map(f => (
              <button
                key={f}
                onClick={() => setFilter(f)}
                className={`px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap transition-colors ${
                  (filter === f || (f === 'all' && filter === 'all'))
                   ? 'bg-cyan-600 text-white'
                    : 'bg-gray-700 text-gray-400 hover:bg-gray-600'
                }`}
              >
                {f === 'all' ? 'Todos' : f.replace('Módulo ', 'Mód ')}
              </button>
            ))}
          </div>
        </div>

        <div className="space-y-6 overflow-y-auto max-h-[800px] pr-2">
          {repertoireData.map((section, idx) => {
             if (filter !== 'all' && !section.module.includes(filter) && !(filter === 'Popular' && section.module.includes('Popular'))) return null;
             
             return (
              <div key={idx} className={`border-l-2 ${section.color} pl-4`}>
                <h3 className="text-lg font-bold text-gray-200 mb-3 flex items-center gap-2">
                  {section.module}
                </h3>
                <div className="grid gap-3">
                  {section.works.map((work, wIdx) => (
                    <div 
                      key={wIdx} 
                      className={`group bg-gray-900/50 p-3 rounded border border-gray-700 hover:border-cyan-500/50 transition-all cursor-pointer ${activeVideo?.title === work.title ? 'border-cyan-500 bg-cyan-900/10' : ''}`}
                    >
                      <div className="flex justify-between items-start">
                        <div>
                          <h4 className="font-bold text-gray-100 text-sm">{work.title}</h4>
                          <span className="text-xs text-cyan-400 font-medium">{work.composer}</span>
                        </div>
                        <span className="text-xs text-gray-500 bg-gray-800 px-2 py-0.5 rounded">{work.year}</span>
                      </div>
                      <p className="text-xs text-gray-400 mt-2 mb-3 line-clamp-2">{work.desc}</p>
                      <div className="flex flex-wrap gap-2">
                        {work.links.map((link, lIdx) => (
                          <button
                            key={lIdx}
                            onClick={(e) => { e.stopPropagation(); handlePlay(work, link); }}
                            className="flex items-center gap-1.5 px-2 py-1.5 bg-gray-800 hover:bg-cyan-600 text-gray-300 hover:text-white rounded text-xs transition-colors"
                          >
                            <Play size={10} className="fill-current" />
                            {link.label}
                          </button>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            );
          })}
        </div>
      </div>

      {/* Player Column (Sticky or Modal-like) */}
      <div className={`lg:w-1/2 transition-all duration-500 ${activeVideo ? 'opacity-100 translate-x-0' : 'opacity-0 translate-x-10 hidden lg:block lg:w-0'}`}>
        <div className="sticky top-6 bg-black/40 rounded-xl overflow-hidden border border-gray-600 shadow-2xl backdrop-blur-sm">
          {activeVideo ? (
            <>
              <div className="bg-gray-800 p-3 flex justify-between items-center border-b border-gray-700">
                <div className="flex items-center gap-2">
                   <div className="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                   <span className="text-sm font-bold text-gray-100 truncate max-w-[200px]">{activeVideo.title}</span>
                </div>
                <button onClick={() => setActiveVideo(null)} className="text-gray-400 hover:text-white">
                  <X size={18} />
                </button>
              </div>
              <div className="relative pt-[56.25%] bg-black">
                <iframe
                  src={`https://www.youtube.com/embed/${activeVideo.videoId}?autoplay=1`}
                  className="absolute top-0 left-0 w-full h-full"
                  title={activeVideo.title}
                  frameBorder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowFullScreen
                ></iframe>
              </div>
              <div className="p-4">
                <h3 className="font-bold text-lg text-cyan-400">{activeVideo.composer}: {activeVideo.title}</h3>
                <p className="text-sm text-gray-300 mt-2">{activeVideo.desc}</p>
                <div className="mt-4 p-3 bg-gray-700/30 rounded text-xs text-gray-400 flex gap-2">
                  <Info size={14} className="flex-shrink-0 mt-0.5" />
                  <p>Observe como o compositor traduz conceitos tecnológicos para a escrita instrumental. Tente identificar momentos de "transdução" auditiva.</p>
                </div>
              </div>
            </>
          ) : (
            <div className="h-64 flex flex-col items-center justify-center text-gray-500 p-8 text-center border-2 border-dashed border-gray-700 rounded-xl m-4">
              <Youtube size={48} className="mb-4 opacity-50" />
              <p>Selecione um vídeo na lista para assistir aqui.</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

// --- OTHER SECTIONS (KEPT COMPACT) ---

const OverviewSection = () => (
  <div className="space-y-8 animate-fadeIn">
    <div>
      <h2 className="text-2xl font-bold text-cyan-400 mb-4 border-b border-gray-700 pb-2">A Premissa do Curso</h2>
      <p className="text-lg leading-relaxed text-gray-300">
        Bem-vindos. O objetivo deste curso não é ensinar a usar o computador para compor, mas sim entender como o computador <span className="text-white font-semibold italic">já reescreveu</span> a maneira como ouvimos e escrevemos para instrumentos acústicos.
      </p>
      <div className="mt-6 p-6 bg-gray-900 rounded-lg border-l-4 border-blue-500">
        <p className="text-xl font-light italic text-gray-200">
          "O tecnomorfismo é a internalização da máquina pelo humano."
        </p>
      </div>
    </div>

    <div>
      <h3 className="text-xl font-bold text-blue-400 mb-4 flex items-center gap-2">
        <BookOpen size={20} /> A Analogia Central: O Espelho Digital
      </h3>
      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-gray-700/50 p-5 rounded-lg border border-gray-600">
          <h4 className="font-bold text-white mb-2">Séculos Passados</h4>
          <p className="text-sm text-gray-300">
            A música instrumental olhava para a <strong>Natureza</strong> (pássaros, trovões) ou para a <strong>Linguagem</strong> (retórica) em busca de modelos.
          </p>
        </div>
        <div className="bg-cyan-900/30 p-5 rounded-lg border border-cyan-700 relative overflow-hidden">
          <div className="absolute top-0 right-0 p-2 opacity-10">
            <Cpu size={64} />
          </div>
          <h4 className="font-bold text-cyan-300 mb-2">Século XX / XXI</h4>
          <p className="text-sm text-gray-300">
            O instrumento acústico olha para o <strong>Espelho Digital</strong> (o estúdio, o sintetizador). Ele vê uma imagem granulada, filtrada, editada e processada.
          </p>
        </div>
      </div>
    </div>
  </div>
);

const ModulesSection = ({ expandedModule, toggleModule }) => {
  const modules = [
    {
      weeks: "Semanas 1-3",
      title: "O Alicerce Filosófico",
      subtitle: "Simondon, Transdução e Tipomorfologia",
      content: "Transdução como conversão de energia. Tipomorfologia de Pierre Schaeffer (massa, grão, allure). Escuta reduzida como ferramenta analítica."
    },
    {
      weeks: "Semanas 4-6",
      title: "A Microcirurgia do Timbre",
      subtitle: "Espectralismo e Síntese Instrumental",
      content: "Análise de espectro (FFT) e orquestração de parciais. Síntese Aditiva Instrumental (Grisey, Murail). Síntese Subtrativa e escultura de ruído."
    },
    {
      weeks: "Semanas 7-9",
      title: "O Tempo Pós-Digital",
      subtitle: "Granulação, Loop e Glitch",
      content: "Síntese Granular e Concatenativa (CSS) como modelos de escrita. A estética do Loop (repetição mecânica) e do Glitch (erro digital)."
    },
    {
      weeks: "Semanas 10-12",
      title: "O Corpo e a Máquina",
      subtitle: "Percussão, Performance e Maximalismo",
      content: "Percussão como sintetizador de ruído branco. O corpo como controlador/avatar (Stefan Prins). Maximalismo e densidade (Flo Menezes)."
    },
    {
      weeks: "Semanas 13-15",
      title: "As Novas Fronteiras",
      subtitle: "Biomoformismo e Improvisação",
      content: "Biomoformismo: tecnologia modelando a natureza. Crítica ao especismo e ecologia sonora. Improvisação livre mediada por escuta de máquina."
    }
  ];

  return (
    <div className="space-y-4">
      <h2 className="text-2xl font-bold text-cyan-400 mb-6">Arco do Curso</h2>
      <div className="relative border-l-2 border-gray-700 ml-3 space-y-6">
        {modules.map((mod, idx) => (
          <div key={idx} className="ml-6 relative">
            <div className={`absolute -left-[31px] top-0 w-4 h-4 rounded-full border-2 ${expandedModule === idx ? 'bg-cyan-500 border-cyan-500' : 'bg-gray-900 border-gray-600'} transition-colors duration-300`}></div>
            <div 
              className={`bg-gray-700/40 rounded-lg border ${expandedModule === idx ? 'border-cyan-600 bg-gray-700/60' : 'border-gray-700'} overflow-hidden cursor-pointer transition-all duration-300 hover:border-gray-500`}
              onClick={() => toggleModule(idx)}
            >
              <div className="p-4 flex justify-between items-center">
                <div>
                  <span className="text-xs font-mono text-cyan-400 mb-1 block">{mod.weeks}</span>
                  <h3 className="font-bold text-lg text-gray-100">{mod.title}</h3>
                  <p className="text-sm text-gray-400">{mod.subtitle}</p>
                </div>
                {expandedModule === idx ? <ChevronUp className="text-cyan-400" /> : <ChevronDown className="text-gray-500" />}
              </div>
              
              {expandedModule === idx && (
                <div className="px-4 pb-4 pt-0 text-gray-300 text-sm border-t border-gray-600/50 mt-2 pt-3 animate-fadeIn">
                  <p>{mod.content}</p>
                </div>
              )}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

const ConceptsSection = () => (
  <div className="space-y-6">
    <h2 className="text-2xl font-bold text-cyan-400 mb-4">Conceitos Fundamentais</h2>
    <div className="grid md:grid-cols-2 gap-4">
      <ConceptCard title="Tecnomorfismo" def="Techne + Morphe" desc="Uso metafórico de processos tecnológicos em meios acústicos." />
      <ConceptCard title="Transdução" def="Simondon" desc="Passagem de informação entre domínios heterogêneos (digital -> acústico)." />
      <ConceptCard title="Escuta Reduzida" def="Schaeffer" desc="Ouvir a morfologia (massa, grão) ignorando a causa do som." />
      <ConceptCard title="Simulativo vs Metafórico" def="Holmes/Catanzaro" desc="Imitar o som (simulativo) vs Imitar a lógica (metafórico)." />
    </div>
  </div>
);

const ConceptCard = ({ title, def, desc }) => (
  <div className="bg-gray-900/50 p-4 rounded-lg border-l-4 border-purple-500 hover:bg-gray-800 transition-colors">
    <h3 className="font-bold text-lg text-white">{title}</h3>
    <span className="text-xs uppercase tracking-wider text-purple-400 font-mono mb-2 block">{def}</span>
    <p className="text-sm text-gray-300">{desc}</p>
  </div>
);

const ToolsSection = () => (
  <div className="space-y-8">
    <div>
      <h2 className="text-2xl font-bold text-cyan-400 mb-4">Ferramentas & Diagnóstico</h2>
      <div className="grid md:grid-cols-2 gap-4">
        <div className="bg-gray-900 p-4 rounded border border-gray-700">
          <h3 className="font-bold text-white mb-2 flex items-center gap-2"><Volume2 size={16}/> Sonic Visualiser</h3>
          <p className="text-sm text-gray-400">Software essencial para análise espectromorfológica. Veremos o "grão" do som.</p>
        </div>
        <div className="bg-gray-900 p-4 rounded border border-gray-700">
          <h3 className="font-bold text-white mb-2 flex items-center gap-2"><Terminal size={16}/> Conceitos DSP</h3>
          <p className="text-sm text-gray-400">Entendimento lógico de Filtros, Delays e Envelopes (sem necessidade de codar).</p>
        </div>
      </div>
    </div>
    <div className="bg-gray-700/30 p-6 rounded-lg border border-gray-600">
      <h3 className="text-xl font-bold text-white mb-4">Diagnóstico Inicial</h3>
      <ul className="space-y-3">
        <li className="text-sm text-gray-200">1. Você já tentou transcrever um som eletrônico para seu instrumento?</li>
        <li className="text-sm text-gray-200">2. Quais compositores brasileiros você associa à tecnologia?</li>
      </ul>
    </div>
  </div>
);

const NavItem = ({ id, label, icon, activeTab, setActiveTab, highlight }) => (
  <li>
    <button
      onClick={() => setActiveTab(id)}
      className={`w-full flex items-center gap-3 px-4 py-3 rounded-md transition-all duration-200 ${
        activeTab === id 
         ? 'bg-cyan-600 text-white shadow-md' 
          : highlight 
            ? 'bg-gray-700 text-cyan-300 hover:bg-gray-600 border border-cyan-900/50'
            : 'text-gray-400 hover:bg-gray-700 hover:text-white'
      }`}
    >
      {icon}
      <span className="text-sm font-medium">{label}</span>
    </button>
  </li>
);
